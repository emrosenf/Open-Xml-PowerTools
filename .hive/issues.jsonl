{"id":"cell--tsysh-mjn0oh7mgrm","title":"Phase 2: WmlComparer Port (Faithful Translation)","description":"**Phase 2: WmlComparer Port (100% Faithful C# Translation)**\n\n## Methodology (NON-NEGOTIABLE)\n1. **Translation-first**: Port C# code line-by-line, preserving structure and naming\n2. **No behavior inference**: Never guess what C# does from test outputs\n3. **Tests validate, not guide**: Run tests only AFTER implementation complete\n4. **When stuck**: Read C# source (WmlComparer.cs:line), not test expectations\n5. **Naming convention**: Rust functions mirror C# method names\n\n## Source Files to Port\n- WmlComparer.cs (8836 lines) - Main comparer\n- RevisionProcessor.cs (~800 lines) - Accept/Reject revisions\n- MarkupSimplifier.cs (~600 lines) - Markup preprocessing\n\n## Target: 539 WML tests pass (268 + 251 + 20 formatting)\n\n## Reference: RUST_MIGRATION_PLAN_SYNTHESIS.md Section 2","status":"open","priority":1,"issue_type":"epic","created_at":"2025-12-26T15:18:58.594Z","updated_at":"2025-12-26T15:49:25.493Z","dependencies":[],"labels":[],"comments":[]}
{"id":"cell--tsysh-mjn1jkfdtjc","title":"WmlComparer Performance Analysis & Rust Optimization","description":"Analyze performance hotspots in WmlComparer and provide Rust implementation optimizations while maintaining byte-for-byte compatibility","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-26T15:43:09.097Z","updated_at":"2025-12-26T15:49:16.216Z","closed_at":"2025-12-26T15:49:16.216Z","dependencies":[],"labels":[],"comments":[]}
{"id":"cell--tsysh-mjn1jkfiicu","title":"Analyze Atomization Performance Hotspots","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-26T15:43:09.102Z","updated_at":"2025-12-26T15:43:14.918Z","closed_at":"2025-12-26T15:43:14.918Z","parent_id":"cell--tsysh-mjn1jkfdtjc","dependencies":[],"labels":[],"comments":[]}
{"id":"cell--tsysh-mjn1jkfkk15","title":"Analyze LCS Algorithm Quadratic Complexity","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-26T15:43:09.104Z","updated_at":"2025-12-26T15:43:20.843Z","closed_at":"2025-12-26T15:43:20.843Z","parent_id":"cell--tsysh-mjn1jkfdtjc","dependencies":[],"labels":[],"comments":[]}
{"id":"cell--tsysh-mjn1jkflqv3","title":"Analyze Coalescing & XML Traversal Costs","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-26T15:43:09.105Z","updated_at":"2025-12-26T15:43:26.056Z","closed_at":"2025-12-26T15:43:26.056Z","parent_id":"cell--tsysh-mjn1jkfdtjc","dependencies":[],"labels":[],"comments":[]}
{"id":"cell--tsysh-mjn1jkfnmvo","title":"Design Optimized Rust Data Structures","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T15:43:09.107Z","updated_at":"2025-12-26T15:43:33.904Z","closed_at":"2025-12-26T15:43:33.904Z","parent_id":"cell--tsysh-mjn1jkfdtjc","dependencies":[],"labels":[],"comments":[]}
{"id":"cell--tsysh-mjn1jkfpw9w","title":"Implement Memory-Efficient LCS Algorithm","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T15:43:09.109Z","updated_at":"2025-12-26T15:43:38.512Z","closed_at":"2025-12-26T15:43:38.512Z","parent_id":"cell--tsysh-mjn1jkfdtjc","dependencies":[],"labels":[],"comments":[]}
{"id":"cell--tsysh-mjn1jkfqdsq","title":"Optimize Atomization with Streaming Approach","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T15:43:09.110Z","updated_at":"2025-12-26T15:43:42.989Z","closed_at":"2025-12-26T15:43:42.989Z","parent_id":"cell--tsysh-mjn1jkfdtjc","dependencies":[],"labels":[],"comments":[]}
{"id":"cell--tsysh-mjn1jkfs9rn","title":"Add Performance Benchmarks","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-26T15:43:09.112Z","updated_at":"2025-12-26T15:43:47.261Z","closed_at":"2025-12-26T15:43:47.261Z","parent_id":"cell--tsysh-mjn1jkfdtjc","dependencies":[],"labels":[],"comments":[]}
{"id":"cell--tsysh-mjn0oh7t5sd","title":"2.1 Types and Settings","description":"**Port WmlComparerSettings and WmlComparerRevision**\n\nFiles: wml/settings.rs (update existing)\n\n## C# Sources\n- WmlComparerSettings (WmlComparer.cs:64-100)\n- WmlComparerConsolidateSettings (WmlComparer.cs:109)\n- WmlRevisedDocumentInfo (WmlComparer.cs:114)\n- WmlComparerRevision + WmlComparerRevisionType (WmlComparer.cs:3861-3884)\n\n## Fields to Port (EXACT defaults required)\n- WordSeparators: char[] with Chinese punctuation (line 100)\n- AuthorForRevisions: Option<String>\n- DateTimeForRevisions: ISO 8601 format\n- DetailThreshold: f64 = 0.15\n- CaseInsensitive: bool = false\n- ConflateBreakingAndNonbreakingSpaces: bool = true\n- TrackFormattingChanges: bool = true\n- CultureInfo: Option<String>\n- StartingIdForFootnotesEndnotes: i32 = 1\n\n## Rust File: redline-rs/crates/redline-core/src/wml/settings.rs","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-26T15:18:58.601Z","updated_at":"2025-12-26T16:17:00.981Z","closed_at":"2025-12-26T16:17:00.981Z","parent_id":"cell--tsysh-mjn0oh7mgrm","dependencies":[],"labels":[],"comments":[]}
{"id":"cell--tsysh-mjn0oh7v9ah","title":"2.2 Comparison Units","description":"**Port ComparisonUnit Hierarchy**\n\nFiles: wml/comparison_unit.rs (rewrite for faithful port)\n\n## C# Sources (WmlComparer.cs)\n- ComparisonUnit abstract base (line 8157-8210)\n- ComparisonUnitWord (line 8212-8278)\n- ComparisonUnitAtom (line 8280-8596)\n- ComparisonUnitGroup (line 8608-8690)\n- ComparisonUnitGroupType enum (line 8599-8606)\n- CorrelationStatus enum (line 8597)\n\n## Critical Fields in ComparisonUnitAtom\n- AncestorElements: XElement[] (body → leaf order)\n- AncestorUnids: String[]\n- ContentElement: XElement\n- Part: OpenXmlPart reference\n- SHA1Hash: computed from content\n- CorrelationStatus: Equal/Inserted/Deleted/Unknown\n- NormalizedRPr: for formatting comparison\n- FormattingSignature: String hash of rPr\n\n## Rust File: redline-rs/crates/redline-core/src/wml/comparison_unit.rs","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-26T15:18:58.603Z","updated_at":"2025-12-26T16:17:01.335Z","closed_at":"2025-12-26T16:17:01.335Z","parent_id":"cell--tsysh-mjn0oh7mgrm","dependencies":[],"labels":[],"comments":[]}
{"id":"cell--tsysh-mjn0oh7xg1i","title":"2.3 RevisionProcessor Port","description":"**Port RevisionProcessor (AcceptRevisions/RejectRevisions)**\n\nFiles: NEW wml/revision_processor.rs\n\n## C# Sources\n- RevisionProcessor.cs (full file ~800 lines)\n- Used by CompareInternal at lines 226-227, 255-256\n\n## Methods to Port\n1. AcceptRevisions(WmlDocument) → WmlDocument\n2. RejectRevisions(WmlDocument) → WmlDocument\n3. AcceptRevisionsForElement(element) - element-level accept\n\n## Purpose in Compare Flow\n1. source1afterAccepting = AcceptRevisions(source1)\n2. source2afterRejecting = RejectRevisions(source2)\n3. Used for HashBlockLevelContent correlation\n4. Re-accept after hashing for actual comparison\n\n## Rust File: redline-rs/crates/redline-core/src/wml/revision_processor.rs","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T15:18:58.605Z","updated_at":"2025-12-26T16:17:01.863Z","closed_at":"2025-12-26T16:17:01.863Z","parent_id":"cell--tsysh-mjn0oh7mgrm","dependencies":[],"labels":[],"comments":[]}
{"id":"cell--tsysh-mjn0oh7yx5o","title":"2.4 MarkupSimplifier Port","description":"**Port MarkupSimplifier**\n\nFiles: NEW wml/simplify.rs\n\n## C# Sources\n- MarkupSimplifier.cs (full file ~600 lines)\n- Called by PreProcessMarkup in WmlComparer\n\n## Key Operations\n1. Merge adjacent runs with same formatting\n2. Remove empty runs and paragraphs\n3. Normalize bookmarks and fields\n4. Handle tracked changes cleanup\n5. Process alternate content (MC:AlternateContent)\n\n## Rust File: redline-rs/crates/redline-core/src/wml/simplify.rs","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T15:18:58.606Z","updated_at":"2025-12-26T16:17:02.293Z","closed_at":"2025-12-26T16:17:02.293Z","parent_id":"cell--tsysh-mjn0oh7mgrm","dependencies":[],"labels":[],"comments":[]}
{"id":"cell--tsysh-mjn0oh85k0v","title":"2.8 Formatting Changes","description":"**Port Formatting Change Detection**\n\nFiles: wml/formatting.rs (update existing)\n\n## C# Sources (WmlComparer.cs)\n- NormalizedRPr computation (line 8380-8466)\n- FormattingSignature generation (line 8298-8310)\n- FormattingChangeRPrBefore handling (line 8300-8345)\n- rPrChange generation in CoalesceRecurse\n\n## Key Logic\n1. Compute NormalizedRPr from w:rPr element\n2. Generate SHA1 FormattingSignature from normalized props\n3. Compare signatures between matched atoms\n4. Generate w:rPrChange elements for format differences\n5. Use TrackFormattingChanges setting\n\n## Rust File: redline-rs/crates/redline-core/src/wml/formatting.rs","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T15:18:58.613Z","updated_at":"2025-12-26T16:38:52.267Z","closed_at":"2025-12-26T16:38:52.267Z","parent_id":"cell--tsysh-mjn0oh7mgrm","dependencies":[],"labels":[],"comments":[]}
{"id":"cell--tsysh-mjn0oh86fdp","title":"2.9 Tree Reconstruction","description":"**Port CoalesceRecurse (Tree Reconstruction)**\n\nFiles: wml/coalesce.rs (rewrite for faithful port)\n\n## C# Sources (WmlComparer.cs)\n- Coalesce() entry (line 7977-7992)\n- CoalesceRecurse() (line 5161-5738)\n- MoveLastSectPrToChildOfBody (line 7987)\n- AssembleAncestorUnidsInOrderToRebuildXmlTreeProperly (line 5043-5012)\n\n## Grouping Logic (CRITICAL)\n1. Group atoms by AncestorUnids[level]\n2. Also group by CorrelationStatus (don't merge across status boundaries)\n3. Also group by FormattingSignature (format change boundaries)\n4. Recurse at each level to build hierarchy\n\n## Special Cases\n- VML/textbox handling (preserve \"before ancestors\")\n- Table structure reconstruction\n- Empty key handling (drop from grouping)\n\n## Rust File: redline-rs/crates/redline-core/src/wml/coalesce.rs","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T15:18:58.614Z","updated_at":"2025-12-26T16:38:53.178Z","closed_at":"2025-12-26T16:38:53.178Z","parent_id":"cell--tsysh-mjn0oh7mgrm","dependencies":[],"labels":[],"comments":[]}
{"id":"cell--tsysh-mjn0oh88t77","title":"2.10 Element Ordering","description":"**Port Element Ordering + MarkContentAsDeletedOrInserted**\n\nFiles: wml/order.rs, wml/mark_revisions.rs\n\n## C# Sources\n- WmlOrderElementsPerStandard (PtOpenXmlUtil.cs)\n- Order_pPr, Order_rPr dictionaries\n- MarkContentAsDeletedOrInserted (WmlComparer.cs:2646)\n- MarkContentAsDeletedOrInsertedTransform (line 2652-2740)\n- FixUpRevisionIds (line 2742-2965)\n\n## Element Ordering\n- Ensure output XML element order matches OOXML standard\n- Critical for: pPr, rPr, tblPr, tcPr, trPr\n\n## Revision Markup Transform\n1. For w:r: wrap in w:del or w:ins based on PtOpenXml.Status\n2. For w:pPr: inject w:rPr with w:del or w:ins markers\n3. Add w:author, w:id, w:date attributes\n4. Sequential ID assignment (s_MaxId++)\n\n## Rust Files: \n- redline-rs/crates/redline-core/src/wml/order.rs\n- redline-rs/crates/redline-core/src/wml/mark_revisions.rs","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T15:18:58.616Z","updated_at":"2025-12-26T16:38:54.967Z","closed_at":"2025-12-26T16:38:54.967Z","parent_id":"cell--tsysh-mjn0oh7mgrm","dependencies":[],"labels":[],"comments":[]}
{"id":"cell--tsysh-mjn0oh8axgq","title":"2.11 Consolidation","description":"**Port Consolidate + GetRevisions**\n\nFiles: wml/consolidate.rs, wml/get_revisions.rs\n\n## C# Sources (WmlComparer.cs)\n- Consolidate() overloads (line 994-1040)\n- ConsolidateInternal (line 1042-1800)\n- ConsolidationInfo class (internal)\n- GetRevisions() (line 3887-3960)\n- WmlComparerRevision extraction logic\n\n## Consolidate Logic\n1. Compare original with each revised document\n2. Merge revision markup from multiple authors\n3. Handle overlapping revisions\n4. Color-code by author (ColorParser)\n\n## GetRevisions Logic\n1. Find all w:ins, w:del elements in document\n2. Extract text, author, date, revision type\n3. Return List<WmlComparerRevision>\n\n## Rust Files:\n- redline-rs/crates/redline-core/src/wml/consolidate.rs\n- redline-rs/crates/redline-core/src/wml/get_revisions.rs","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-26T15:18:58.618Z","updated_at":"2025-12-26T16:38:56.249Z","closed_at":"2025-12-26T16:38:56.249Z","parent_id":"cell--tsysh-mjn0oh7mgrm","dependencies":[],"labels":[],"comments":[]}
{"id":"cell--tsysh-mjn0oh80z4a","title":"2.5 Preprocessing","description":"**Port PreProcessMarkup Pipeline**\n\nFiles: wml/preprocess.rs (update existing)\n\n## C# Sources (WmlComparer.cs)\n- PreProcessMarkup (line ~175-225)\n- AssignUnidToAllElements (line 8136)\n- HashBlockLevelContent (line 241-242)\n- MoveLastSectPrIntoLastParagraph (line 7994)\n\n## Pipeline Steps (EXACT order required)\n1. SimplifyMarkup() - normalize document\n2. AssignUnidToAllElements() - add pt:Unid GUIDs\n3. Accept/Reject revisions for hashing\n4. HashBlockLevelContent() - add pt:SHA1Hash, pt:CorrelatedSHA1Hash\n5. Repair Unids after SDK revision acceptance\n\n## Rust File: redline-rs/crates/redline-core/src/wml/preprocess.rs","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T15:18:58.608Z","updated_at":"2025-12-26T16:54:10.866Z","closed_at":"2025-12-26T16:54:10.866Z","parent_id":"cell--tsysh-mjn0oh7mgrm","dependencies":[],"labels":[],"comments":[]}
{"id":"cell--tsysh-mjn0oh8250l","title":"2.6 LCS Algorithm","description":"**Port Full LCS Algorithm**\n\nFiles: wml/lcs.rs (rewrite for faithful port)\n\n## C# Sources (WmlComparer.cs)\n- Lcs main loop (line 5779-5936)\n- SetAfterUnids (line 5848-5936)\n- ProcessCorrelatedHashes (line 5938-6137)\n- FindCommonAtBeginningAndEnd (line 4489-4972)\n- DoLcsAlgorithm (line 6148-6724)\n- DoLcsAlgorithmForTable (line 7145)\n- DetectUnrelatedSources (line 5745)\n\n## Decision Chain (EXACT order in loop)\n1. SetAfterUnids(unknown) - propagate GUIDs\n2. ProcessCorrelatedHashes(unknown) - hash-driven matching\n3. FindCommonAtBeginningAndEnd(unknown) - prefix/suffix trim\n4. DoLcsAlgorithm(unknown) - core LCS search\n\n## DetailThreshold Gate\n- Discard matches below 15% of total window\n\n## Rust File: redline-rs/crates/redline-core/src/wml/lcs.rs","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-26T15:18:58.610Z","updated_at":"2025-12-26T16:54:12.637Z","closed_at":"2025-12-26T16:54:12.637Z","parent_id":"cell--tsysh-mjn0oh7mgrm","dependencies":[],"labels":[],"comments":[]}
{"id":"cell--tsysh-mjn0oh83tby","title":"2.7 Core Comparison","description":"**Port Core Comparison (ProduceDocumentWithTrackedRevisions)**\n\nFiles: wml/comparer.rs (rewrite for faithful port)\n\n## Status: Pipeline Complete, Revision Counting Issue\n\nThe full pipeline is now wired up:\n1. ✅ PreProcessMarkup both docs\n2. ✅ CreateComparisonUnitAtomList on each part\n3. ✅ GetComparisonUnitList → hierarchical grouping\n4. ✅ Lcs() → correlate sequences\n5. ✅ FlattenToComparisonUnitAtomList → back to atoms\n6. ✅ CoalesceRecurse → rebuild XML tree\n7. ✅ XML serialization to result document bytes\n\n## Current Issue\nTests show 0 revisions for most text-change scenarios. The `count_revision_atoms` \nfunction gets no Inserted/Deleted atoms from `flatten_to_atoms`. Either:\n- Atoms aren't being extracted correctly\n- LCS is treating everything as Equal\n- Or the hash comparison is matching when it shouldn't\n\nNeeds debugging at the atom extraction level to trace why text changes\naren't generating Deleted/Inserted statuses.\n\n## Rust File: redline-rs/crates/redline-core/src/wml/comparer.rs","status":"in_progress","priority":0,"issue_type":"task","created_at":"2025-12-26T15:18:58.611Z","updated_at":"2025-12-26T17:08:52.920Z","parent_id":"cell--tsysh-mjn0oh7mgrm","dependencies":[],"labels":[],"comments":[]}
